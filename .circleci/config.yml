version: 2
jobs:
  lint:
    docker:
      - image: koalaman/shellcheck-alpine
    steps:
      - checkout
      - run:
          name: lint
          command: |
            shellcheck -x build.sh
            shellcheck -x tag.sh
  release:
    docker:
      - image: golang:1.11.1-alpine3.8
    working_directory: /workdir
    steps:
      - setup_remote_docker
      - run:
          name: Install tools
          command: |
            apk add bash build-base ca-certificates curl docker git openssh
            curl -SLO https://github.com/goreleaser/goreleaser/releases/download/v0.89.0/goreleaser_Linux_x86_64.tar.gz
            mkdir -p /usr/local/goreleaser
            tar -xzf goreleaser_Linux_x86_64.tar.gz -C /usr/local/goreleaser
            ln -s /usr/local/goreleaser/goreleaser /usr/local/bin/goreleaser
            rm -rf goreleaser_Linux_x86_64.tar.gz
      - checkout
      - run:
          name: Checkout tag
          command: git checkout -b "$CIRCLE_TAG" "$CIRCLE_TAG"
      - run:
          name: Create release
          command: |
            go mod download
            ./build.sh --debug --release
workflows:
  version: 2
  untagged-build:
    jobs:
      - lint
  tagged-build:
    jobs:
      - release:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
